from fastapi import FastAPI, Query
import requests
import math

app = FastAPI()

SHEETDB_URL = "https://sheetdb.io/api/v1/y7b56e2q4vutg"

def calc_dist(lat1, lon1, lat2, lon2):
    return math.sqrt((lat1 - lat2)**2 + (lon1 - lon2)**2)

@app.get("/nearest")
def nearest(lat: float = Query(...), lon: float = Query(...)):
    # 抓 SheetDB 資料
    data = requests.get(SHEETDB_URL).json()

    nearest_row = None
    min_dist = 999999999

    for row in data:
        try:
            slat = float(row["UNIT_LAT"])
            slon = float(row["UNIT_LON"])
        except:
            continue

        dist = calc_dist(lat, lon, slat, slon)

        if dist < min_dist:
            min_dist = dist
            nearest_row = row

    if nearest_row:
        return {
            "UNIT_NM": nearest_row["UNIT_NM"],
            "UNIT_ADDR": nearest_row["UNIT_ADDR"]
        }
    else:
        return {"error": "no data"}
